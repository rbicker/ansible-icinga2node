---
# tasks for linux hosts

- name: check if parent host's icinga port is reachable
  wait_for:
    host: "{{ icinga2_parent_host }}"
    port: "{{ icinga2_parent_port }}"
    state: started
    delay: 0
    timeout: 10

- name: Install Icinga2 (RedHat)
  when: ansible_os_family == "RedHat" or ansible_os_family == "Rocky"
  block:
  - name: ensure icinga2 repository is installed
    yum:
      name: "{{ icinga2_repo_icinga_url }}"
      disable_gpg_check: yes
    when: icinga2_node_repo_icinga_install

  - name: ensure epel-release is installed
    yum:
      name: epel-release
      state: present
    when: icinga2_node_repo_epel_install
    tags:
      - molecule-idempotence-notest

  - name: ensure icinga2 is installed (RedHat)
    yum:
      name: icinga2
      disable_gpg_check: yes
      state: latest  # noqa 403

  - name: ensure nagios-plugins are installed (RedHat)
    yum:
      name: "{{ icinga2_node_nagios_plugins_rh }}"
      state: latest  # noqa 403


- name: Install Icinga2 (Debian)
  when: ansible_os_family == "Debian"
  block:
  - name: ensure icinga2 is installed (Debian)
    apt:
      name: icinga2
      state: latest  # noqa 403
      update_cache: yes

  - name: ensure nagios-plugins are installed (Debian)
    apt:
      name: "{{ icinga2_node_nagios_plugins_deb }}"
      state: latest  # noqa 403
      cache_valid_time: 86400

  - name: Ensure ownership of /etc/icinga2 subdirs
    # Ubuntu and Debian install everything as owned by root:root, which prevents all
    # the automation later. Reported to Debian in 2016 at
    # https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=824482,
    # apparently still a problem on Ubuntu in 2022.
    file:
      state: directory
      path: /etc/icinga2
      recurse: yes
      owner: "{{ icinga2_node_owner }}"
      group: "{{ icinga2_node_group }}"

- name: ensure icinga2 service restarts on failure
  blockinfile:
    path: /etc/systemd/system/icinga2.service.d/override.conf
    block: |
          [Service]
          Restart=on-failure
    state: "{{ 'present' if icinga2_restart_on_failure else 'absent' }}"
    create: yes
  notify:
    - linux daemon-reload
    - linux node restart icinga2 service

- name: ensure icinga2 service is enabled
  service:
    name: icinga2
    enabled: true

- name: ensure rpcbind.socket is disabled
  systemd:
    name: '{{ item }}'
    enabled: false
    state: stopped
  with_items:
    - rpcbind.socket
    - rpcbind.service
  when: false # error -> rpcbind service / socket does not exist on new systems

- name: configuration
  include_tasks: linux_config.yml
  when: not icinga2_install_only
